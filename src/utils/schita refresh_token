import requests, base64, json, time

CLIENT_ID = dbutils.secrets.get(scope="spotify_secrets", key="user")
CLIENT_SECRET = dbutils.secrets.get(scope="spotify_secrets", key="client_secret")
REDIRECT_URI = "http://127.0.0.1:5000/callback"
CODE = "AQA8C_zZC487pFxtP9uVTouMFdJF6VzHBxnJw_1cihP7FkmaVs_39YhHhhwD7ldiAFW7Gh4s0x1RHPtT4CNcqrcbnke_o7ON_lKrpJdgzfeupa-DD4c1ZiOTamg276w0oTS0uVW2-U2XIX-mE_olesUvalEXuCqzryW-kguD0_9PjLfehNz2xgqyoWPQG7n7hwP3rLbnlciqs2B5SEH1VA2CGw8KcGKB63X0RHEj7gOpy4S_YOLtWZQHKDtFcJ8QOzOER0FHDzKnmEGG1l5uPBkB9jY"  # din URL

auth = base64.b64encode(f"{CLIENT_ID}:{CLIENT_SECRET}".encode()).decode()
r = requests.post(
    "https://accounts.spotify.com/api/token",
    headers={"Authorization": f"Basic {auth}", "Content-Type": "application/x-www-form-urlencoded"},
    data={"grant_type":"authorization_code","code":CODE,"redirect_uri":REDIRECT_URI},
    timeout=20
)
r.raise_for_status()
tokens = r.json()
tokens["expires_at"] = int(time.time()) + int(tokens.get("expires_in", 3600)) - 30

with open("spotify_tokens.json", "w", encoding="utf-8") as f:
    json.dump(tokens, f, indent=2)

print("refresh_token =", tokens.get("refresh_token"))



============================================================
import urllib.parse

client_id = client_id = dbutils.secrets.get(scope="spotify_secrets", key="user")
redirect_uri = "http://127.0.0.1:5000/callback"
scopes = "user-read-recently-played user-read-playback-state user-read-currently-playing"

auth_url = "https://accounts.spotify.com/authorize?" + urllib.parse.urlencode({
    "client_id": client_id,
    "response_type": "AQA8C_zZC487pFxtP9uVTouMFdJF6VzHBxnJw_1cihP7FkmaVs_39YhHhhwD7ldiAFW7Gh4s0x1RHPtT4CNcqrcbnke_o7ON_lKrpJdgzfeupa-DD4c1ZiOTamg276w0oTS0uVW2-U2XIX-mE_olesUvalEXuCqzryW-kguD0_9PjLfehNz2xgqyoWPQG7n7hwP3rLbnlciqs2B5SEH1VA2CGw8KcGKB63X0RHEj7gOpy4S_YOLtWZQHKDtFcJ8QOzOER0FHDzKnmEGG1l5uPBkB9jY",
    "redirect_uri": redirect_uri,
    "scope": scopes
})

print(auth_url)



============================================



import requests
import base64

code = "AQA8C_zZC487pFxtP9uVTouMFdJF6VzHBxnJw_1cihP7FkmaVs_39YhHhhwD7ldiAFW7Gh4s0x1RHPtT4CNcqrcbnke_o7ON_lKrpJdgzfeupa-DD4c1ZiOTamg276w0oTS0uVW2-U2XIX-mE_olesUvalEXuCqzryW-kguD0_9PjLfehNz2xgqyoWPQG7n7hwP3rLbnlciqs2B5SEH1VA2CGw8KcGKB63X0RHEj7gOpy4S_YOLtWZQHKDtFcJ8QOzOER0FHDzKnmEGG1l5uPBkB9jY"  # din URL-ul redirectat
client_id = client_id = dbutils.secrets.get(scope="spotify_secrets", key="user")
client_secret = "7d81b48def1e427580328769dd1349df"
redirect_uri = "http://127.0.0.1:5000/callback"

auth_str = f"{client_id}:{client_secret}"
b64_auth_str = base64.b64encode(auth_str.encode()).decode()

token_url = "https://accounts.spotify.com/api/token"
response = requests.post(token_url, data={
    "grant_type": "authorization_code",
    "code": code,
    "redirect_uri": redirect_uri
}, headers={
    "Authorization": f"Basic {b64_auth_str}"
})

token_info = response.json()
print(token_info)


===================================================================